<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–¢–æ–ª–∫–æ–≤–∞—Ç–µ–ª—å —Å–Ω–æ–≤</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <!-- –≤–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å, –Ω–∞ –Ω–µ–π –∫—Ä–µ–ø–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞ –≤–æ–π—Ç–∏ –∏ –≤—ã–π—Ç–∏ -->
    <div class="top-bar">
        {% if current_user.is_authenticated %}
            <a href="{{ url_for('logout') }}" class="login-btn">–í—ã–π—Ç–∏</a>
        {% else %}
            <a href="{{ url_for('login') }}" class="login-btn">–í–æ–π—Ç–∏</a>
        {% endif %}
    </div>
    <!-- –∫–Ω–æ–ø–∫–∞ –±–æ–∫–æ–≤–π –ø–∞–Ω–µ–ª–∏ -->
    <button id="toggle-sidebar-btn" class="sidebar-toggle-btn">
        <svg viewBox="0 0 100 80" width="30" height="30" fill="white">
            <rect width="100" height="10"></rect>
            <rect y="30" width="100" height="10"></rect>
            <rect y="60" width="100" height="10"></rect>
        </svg>
    </button>
    
    
    <!-- –±–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <aside id="sidebar" class="sidebar hidden">
        <div class="sidebar-header">
            <button id="toggle-home-btn" class="home-toggle-btn">sleepStructure</button>
            {% if current_user.is_authenticated %}
                <h2>–í–∞—à–∏ —Å–Ω—ã:</h2>
            {% endif %}
        </div>
        {% if current_user.is_authenticated %}
            <ul>
                {% set categories = {
                    'today': '–°–µ–≥–æ–¥–Ω—è',
                    'yesterday': '–í—á–µ—Ä–∞',
                    'last_7_days': '–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π',
                    'last_30_days': '–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π',
                    'older': '–°—Ç–∞—Ä—ã–µ'
                } %}
                {% set ns = namespace(has_chats=false) %}
                {% for cat, label in categories.items() %}
                    {% if session_data.get(cat) and session_data[cat]|length > 0 %}
                        <li class="category-label">{{ label }}</li>
                        {% for s in session_data[cat] %}
                            <li>
                                <a href="{{ url_for('chat', session_id=s.session_id) }}" class="chat-link">
                                    {{ s.last_message }}
                                </a>
                                <span class="delete-btn" data-session-id="{{ s.session_id }}">‚úñ</span>
                            </li>
                            {% set ns.has_chats = true %}
                        {% endfor %}
                    {% endif %}
                {% endfor %}
                {% if not ns.has_chats %}
                    <li>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤</li>
                {% endif %}
            </ul>
        {% else %}
            <p class="not-auth">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∂—É—Ä–Ω–∞–ª —Å–Ω–æ–≤.</p>
        {% endif %}
    </aside>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
    <div id="confirmationModal" class="modal hidden">
        <div class="modal-content">
            <p id="confirmationText">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?</p>
            <div class="modal-buttons">
                <button id="confirmDeleteBtn">–î–∞</button>
                <button id="cancelDeleteBtn">–ù–µ—Ç</button>
            </div>
        </div>
    </div>

    {% block content %}
    {% endblock %}

     <!-- —ç—Ç–æ –¥–ª—è chat.html, —Å—é–¥–∞ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å—Å—è –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ, –∏–±–æ –æ–Ω –Ω–∞—Å–ª–µ–¥—É–µ—Ç —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É -->
    <!-- –≤ chat.html 1 stroke -->
    {% if request.endpoint == 'index' %}
    <div class="center-input-form">
        <form method="POST" action="/analyze" onsubmit="return checkAuth();">
            <div class="center-input">
                {% if current_user.is_authenticated %}
                    <h1>–ü—Ä–∏–≤–µ—Ç, {{ current_user.username}}! –ß—Ç–æ —Å–Ω–∏–ª–æ—Å—å —Å–µ–≥–æ–¥–Ω—è?</h1>
                {% else %}
                    <p class="not-auth">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –∏–Ω—Ç–µ—Ä–µ–Ω—Å—ã–µ —Ñ–∞–∫—Ç—ã –æ –≤–∞—à–µ–º —Å–Ω–µ!</p>
                {% endif %}
                <div class="input-wrapper">
                    <textarea name="dream" rows="1" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à —Å–æ–Ω..." required
                        {% if not current_user.is_authenticated %} disabled {% endif %}></textarea>
                    <button class="send-btn" type="submit" id="send-btn">üé§</button>
                </div>
                <div id="login-warning" class="login-warning hidden">–í—ã –Ω–µ –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É</div>
            </div>
            {% if current_user.is_authenticated %}
                {% set first_session_id = None %}
                {% for cat in ['today', 'yesterday', 'last_7_days', 'last_30_days', 'older'] %}
                    {% if session_data.get(cat) and session_data[cat]|length > 0 %}
                        {% set first_session_id = session_data[cat][0].session_id %}
                    {% endif %}
                {% endfor %}
                <input type="hidden" name="session_id" value="{{ first_session_id or '' }}">
            {% endif %}
        </form>
    </div>
    {% endif %}

<footer class="disclaimer">
    <p>–í–µ–±—Å–∞–π—Ç –º–æ–∂–µ—Ç –¥–æ–ø—É—Å–∫–∞—Ç—å –æ—à–∏–±–∫–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.</p>
</footer>
    
<script>
const toggleSideBarBtn = document.getElementById('toggle-sidebar-btn');
const sidebar = document.getElementById('sidebar');

// —É–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞
document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('sidebar');
    const deleteButtons = document.querySelectorAll('.delete-btn');
    const confirmationModal = document.getElementById('confirmationModal');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const confirmationText = document.getElementById('confirmationText');

    let sessionIdToDelete = null;

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–∞–Ω–µ–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (localStorage.getItem('sidebarState') === 'visible') {
        sidebar.classList.add('visible');
        sidebar.classList.remove('hidden');
    }

    deleteButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            sessionIdToDelete = this.getAttribute('data-session-id');
            const chatTitle = this.previousElementSibling.textContent; // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç —á–∞—Ç–∞
            confirmationText.textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?\n${chatTitle}`;
            confirmationModal.classList.remove('hidden');
        });
    });

    confirmDeleteBtn.addEventListener('click', function() {
        if (sessionIdToDelete) {
            fetch(`/delete_chat/${sessionIdToDelete}`, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (window.location.pathname.includes('/chat/')) {
                        if (sidebar.classList.contains('visible')) {
                            localStorage.setItem('sidebarState', 'visible');
                        } else {
                            localStorage.setItem('sidebarState', 'hidden');
                        }
                        window.location.href = "/";
                    } else {
                        const chatItem = document.querySelector(`.delete-btn[data-session-id="${sessionIdToDelete}"]`).parentElement;
                        chatItem.remove();
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–∞—Ç–∞');
                }
                confirmationModal.classList.add('hidden');
            });
        }
    });

    cancelDeleteBtn.addEventListener('click', function() {
        confirmationModal.classList.add('hidden');
        sessionIdToDelete = null;
    });
});

// –∫–Ω–æ–ø–∫–∞ "–≥–ª–∞–Ω–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞", –∫–ª–∏–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Å–∞–π—Ç–∞
document.getElementById("toggle-home-btn").addEventListener('click', () => {
    window.location.href = "/";
});

// –¥–µ–ª–∞–µ—Ç –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å –ª–∏–±–æ –≤–∏–¥–∏–º–æ–π, –ª–∏–±–æ –Ω–µ—Ç
toggleSideBarBtn.addEventListener('click', () => {
    sidebar.classList.toggle('visible');
    sidebar.classList.toggle('hidden');
});

// —Å–∫—Ä–∏–ø—Ç, –º–µ–Ω—è–µ—Ç –∑–Ω–∞—á–µ–∫ —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –Ω–∞ —Å—Ç—Ä–µ–ª–∫—É
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.querySelector('textarea[name="dream"]');
    const sendBtn = document.getElementById('send-btn');
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
    textarea.addEventListener('input', function() {
        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏
        if (this.value.trim() !== '') {
            sendBtn.textContent = '‚û§';
        } else {
            sendBtn.textContent = 'üé§';
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –≤—ã—Å–æ—Ç—ã
        if (this.scrollHeight > 200) {
            this.style.overflowY = 'auto';
        } else {
            this.style.overflowY = 'hidden';
        }
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã—Å–æ—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    textarea.dispatchEvent(new Event('input'));
});

// —Ñ-—Ü–∏—è, –Ω–µ –¥–∞–µ—Ç —Å–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å, –µ—Å–ª–∏ –µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω + –≤–∫–ª—é—á–∞–µ—Ç –ø—É–ª—å—Å–∞—Ü–∏—é –∫–Ω–æ–ø–∫–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç
function checkAuth() {
    const isAuth = {{ 'true' if current_user.is_authenticated else 'false' }};
    if (!isAuth) {
        const loginBtn = document.querySelector('.login-btn');
        loginBtn.classList.add('pulse');

        const warning = document.getElementById('login-warning');
        warning.classList.remove('hidden');

        setTimeout(() => {
            loginBtn.classList.remove('pulse');
            warning.classList.add('hidden');
        }, 4000);

        return false;
    }
    return true;
}
</script>

</body>
</html>

